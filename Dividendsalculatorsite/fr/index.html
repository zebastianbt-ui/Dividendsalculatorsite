<!doctype html>
<html lang="fr" data-theme="light">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K1LSD4FW61"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K1LSD4FW61');
</script>
<meta charset="utf-8"/>
<meta name="google-adsense-account" content="ca-pub-4394814091372953">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4394814091372953"
     crossorigin="anonymous"></script>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Calculatrice de dividendes – DRIP, projections 10 ans, rendement</title>
<meta name="description" content="Calculatrice de dividendes en français (DRIP inclus). Estimez vos revenus, rendement sur PRU, projections sur 10 ans, avec ou sans réinvestissement des dividendes.">

<!-- HREFLANG (3 langues + x-default=EN) -->
<link rel="alternate" hreflang="fr" href="../fr/"/>
<link rel="alternate" hreflang="en" href="../en/"/>
<link rel="alternate" hreflang="sv" href="../sv/"/>
<link rel="alternate" hreflang="x-default" href="../en/"/>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
  /* Police fraîche pour le titre */
  @import url('https://fonts.googleapis.com/css2?family=Sora:wght@600;700;800&display=swap');

  :root{
    --bg:#faf7fb; --card:#fff; --ink:#1f1b24; --muted:#6a6873;
    --border:#eadcec; --brand:#b40f67; --accent:#079455; --soft:#fff4fb; --soft-border:#ffd2ef; --tile:#f7f2f7;
    /* accents violet/rose style Solana/Make */
    --violet:#7c3aed; --rose:#ff4d94;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#151218; --card:#1d1923; --ink:#f6eef8; --muted:#bdb7c4;
      --border:#3a3241; --brand:#db3e8e; --accent:#41d59b; --soft:#2a2130; --soft-border:#3c2a35; --tile:#241f2a;
      --violet:#8b5cf6; --rose:#ff6aa8;
    }
  }
  [data-theme="dark"]{
    --bg:#151218; --card:#1d1923; --ink:#f6eef8; --muted:#bdb7c4;
    --border:#3a3241; --brand:#db3e8e; --accent:#41d59b; --soft:#2a2130; --soft-border:#3c2a35; --tile:#241f2a;
    --violet:#8b5cf6; --rose:#ff6aa8;
  }
  /* Forcer l'affichage initial en mode jour (light) */
  [data-theme="light"]{
    --bg:#faf7fb; --card:#fff; --ink:#1f1b24; --muted:#6a6873;
    --border:#eadcec; --brand:#b40f67; --accent:#079455; --soft:#fff4fb; --soft-border:#ffd2ef; --tile:#f7f2f7;
    --violet:#7c3aed; --rose:#ff4d94;
  }

  *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  /* Barre de titre avec bouton Partager à droite */
  .titlebar{position:relative; margin-bottom:8px; padding-top:56px;}
  /* Titre centré, plus grand, police Sora + dégradé violet/rose */
  h1{
    font-family:'Sora',system-ui,-apple-system,Segoe UI,Roboto,Arial;
    text-align:center;
    font-size:40px;
    margin:0 0 12px;
    font-weight:800;
    background: linear-gradient(90deg,var(--violet),var(--rose));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .share-btn{
    position:absolute; right:0; top:0;
    padding:8px 12px; border:0; border-radius:10px;
    background:linear-gradient(90deg,var(--violet),var(--rose));
    color:#fff; font-weight:700; cursor:pointer;
  }
  /* Bouton jour/nuit sous Partager (même taille que Partager) */
  .theme-btn{
    position:absolute; right:0; top:46px;
    padding:8px 12px; border:0; border-radius:10px;
    background:linear-gradient(90deg,var(--violet),var(--rose));
    color:#fff; font-weight:700; cursor:pointer;
  }
  .share-menu{
    position:absolute; right:0; top:42px; background:var(--card); border:1px solid var(--border);
    border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:8px; display:none; z-index:10; min-width:220px;
  }
  .share-menu button, .share-menu a{
    width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; cursor:pointer;
    color:var(--ink); border-radius:8px; display:block; text-decoration:none;
  }
  .share-menu button:hover, .share-menu a:hover{ background:var(--tile) }

  .label{font-size:16px;font-weight:700;color:var(--ink);margin:16px 4px 8px}
  input,select{width:100%;padding:14px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:var(--card);color:var(--ink)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  /* bouton avec dégradé violet/rose */
  .btn{
    margin-top:16px;width:100%;padding:14px;border:0;border-radius:12px;
    background:linear-gradient(90deg,var(--violet),var(--rose));
    color:#fff;font-weight:700;font-size:18px;cursor:pointer
  }
  .pill{margin-top:16px;background:var(--soft);border:1px solid var(--soft-border);border-radius:12px;padding:16px;text-align:center}
  .yield{font-size:32px;font-weight:900;color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  .kpi{background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:12px}
  .kpi small{color:var(--ink); font-weight:700;}
  .kpi b{display:block;font-size:18px;margin-top:4px}
  .inline{display:grid;grid-template-columns: 1fr 110px 100px;gap:8px;align-items:center}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .foot{margin:12px 0;color:var(--muted);font-size:12px;text-align:center}
  /* Bas de page: Réinitialiser plein largeur */
  .actions{display:grid; grid-template-columns:1fr; gap:10px; margin-top:16px}
  .btn-outline{flex:0 0 auto; padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--ink);font-weight:700;cursor:pointer}

  /* === PRU: champ simple (checkbox supprimée) === */
  .pru-line{display:block}

  /* Section titres pour catégories */
  .section-title{
    margin-top:36px; margin-bottom:12px; font-weight:800; letter-spacing:.2px;
    color:var(--ink);
  }
  /* Titre violet centré et police cool (Sora) */
  .violet-title{
    font-family:'Sora',system-ui,-apple-system,Segoe UI,Roboto,Arial;
    text-align:center; color:var(--violet); font-weight:800; letter-spacing:.2px;
    margin:10px 0;
  }
  /* Zone projections */
  .proj-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  /* Grille 2 colonnes pleine largeur (pour 2 cases gauche/droite) */
  .proj-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  .tbl{width:100%; border-collapse:collapse; margin-top:12px; font-size:14px}
  .tbl th,.tbl td{border:1px solid var(--border); padding:10px; text-align:right}
  .tbl th{text-align:left; background:var(--tile)}
  .chart-card{margin-top:16px}

  /* Grilles spécifiques */
  .pill-grid{display:grid;grid-template-columns:2fr 2px 1fr;gap:12px;align-items:stretch}
  .v-sep{width:2px; background:var(--rose); border-radius:1px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:14px}

  /* Tooltips (ⓘ) */
  .tip{display:inline-flex; align-items:center; gap:6px}
  .info{
    display:inline-block; width:18px; height:18px; line-height:18px; text-align:center;
    border-radius:50%; background:var(--tile); border:1px solid var(--border); font-size:12px; cursor:help; position:relative;
  }
  .info:hover .tiptext{opacity:1; visibility:visible; transform:translateY(0)}
  .tiptext{
    position:absolute; left:50%; top:-8px; transform:translate(-50%,-8px);
    background:var(--card); color:var(--ink); border:1px solid var(--border);
    border-radius:8px; padding:8px 10px; font-size:12px; line-height:1.3; white-space:normal; width:240px;
    opacity:0; visibility:hidden; transition:.15s ease; z-index:20; box-shadow:0 8px 20px rgba(0,0,0,.08)
  }

  /* Ligne de boutons pour projections */
  .proj-actions{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
  /* Centrer explicitement la note DRIP */
  .drip-note{margin-top:8px; font-size:12px; color:var(--muted); text-align:center}

  /* Résumé au-dessus du graphique */
  .summary{margin-top:8px; font-size:14px; color:var(--ink); text-align:center}

  /* Ajustements demandés */
  /* Centrage plus marqué du bloc YOC (titre + ⓘ + valeur + hint) */
  .pill-grid > div:first-child{ text-align:center }
  /* Investissement total plus grand et centré */
  .kpi-cost{ text-align:center }
  .kpi-cost small{ font-size:16px }
  .kpi-cost b{ font-size:28px; margin-top:6px }

  /* Selecteur de langue simple, sans casser le style existant */
  .lang-switch{position:absolute; left:0; top:0; display:flex; gap:8px; font-weight:700; font-size:14px}
  .lang-switch a{ color:var(--ink); text-decoration:none; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--card)}
  .lang-switch .active{ background:var(--tile) }

  /* Mobile responsive */
  @media (max-width: 560px){
    .row, .grid, .grid3, .proj-grid, .proj-grid-2, .pill-grid{grid-template-columns:1fr!important}
    .v-sep{display:none}
    .inline{grid-template-columns:1fr 1fr; gap:8px}
    .titlebar{margin-bottom:12px}
    .theme-btn{ top:48px; }
    .lang-switch{ top:-6px; }
  }

  @media print{ .chart-card{display:none!important} .wrap{margin:0;padding:0} .card{border:none;box-shadow:none} }
  /* Réinitialiser occupe 100% */
  #clear{padding:12px;font-size:16px;width:100%}
</style>
<!-- Chart.js pour la projection -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="titlebar">
      <h1>Calculatrice de dividendes</h1>

      <!-- Sélecteur de langue (liens relatifs) -->
      <nav class="lang-switch" aria-label="Sélecteur de langue">
        <a class="active" href="../fr/" lang="fr" aria-current="page">FR</a>
        <a href="../en/" lang="en">EN</a>
        <a href="../sv/" lang="sv">SV</a>
      </nav>

      <!-- Bouton Partager en haut à droite -->
      <button class="share-btn" id="shareBtn">Partager</button>
      <!-- Bouton Jour/Nuit sous Partager (même taille, emojis) -->
      <button class="theme-btn" id="themeToggle">☀️ 🌙</button>

      <div class="share-menu" id="shareMenu">
        <button id="copyLink">Copier le lien</button>
        <a id="shareEmail" href="#" target="_blank" rel="noopener">Partager par email</a>
        <a id="shareFB" href="#" target="_blank" rel="noopener">Partager sur Facebook</a>
        <button id="shareIG">Partager sur Instagram</button>
        <a id="shareX" href="#" target="_blank" rel="noopener">Partager sur X</a>
        <button id="exportCSV">Exporter le tableau (CSV)</button>
      </div>

      <!-- ADS PLACEHOLDER (non intrusif) -->
      <!--
        [ADS_TOP] Bannière 728x90 ou responsive
        Exemple : <div id="ads-top"></div>
      -->
    </div>

    <!-- ==== CATÉGORIE 1 : Entrées principales ==== -->
    <div class="row">
      <div>
        <div class="label">Nombre d’actions</div>
        <input id="shares" type="number" inputmode="decimal" value="100">
      </div>
      <div>
        <div class="label">Prix moyen d’achat (PRU)</div>
        <div class="pru-line">
          <input id="pru" type="number" inputmode="decimal" placeholder="ex: 200">
        </div>
      </div>
    </div>

    <!-- Rendement sur PRU + Montant du dividende -->
    <div class="row">
      <div>
        <div class="label tip" style="justify-content:center;">
          Rendement sur PRU (yield on cost)
          <span class="info">ⓘ
            <span class="tiptext">Dividende par action ÷ PRU × 100. Indique votre rendement basé sur votre prix d’achat.</span>
          </span>
        </div>
        <input id="currentPrice" type="number" inputmode="decimal" placeholder="ex: 215">
      </div>
      <div>
        <div class="label">Montant du dividende</div>
        <div class="inline">
          <select id="dMode">
            <option value="amount" selected>Montant</option>
            <option value="percent">%</option>
          </select>
          <input id="dVal" type="number" inputmode="decimal" value="4">
        </div>
        <div class="hint" id="dHint" style="display:none"></div>
      </div>
    </div>

    <button class="btn" id="calc">Calculer</button>

    <!-- ==== CATÉGORIE 2 : KPIs et prix actuel ==== -->
    <div class="pill">
      <div class="pill-grid">
        <div>
          <div class="violet-title tip" style="justify-content:center;">
            Rendement sur PRU (yield on cost)
            <span class="info">ⓘ
              <span class="tiptext">Rendement basé sur votre PRU, pas sur le cours actuel.</span>
            </span>
          </div>
          <div class="yield" id="yieldOnCost">—</div>
          <div class="hint" id="yocRef"></div>
        </div>
        <div class="v-sep" aria-hidden="true"></div>
        <div class="kpi kpi-cost">
          <small>Investissement total</small><b id="cost">—</b>
        </div>
      </div>
    </div>

    <div class="grid3">
      <div class="kpi"><small>Dividende mensuel</small><b id="monthly">—</b></div>
      <div class="kpi"><small>Dividende trimestriel</small><b id="quarterly">—</b></div>
      <div class="kpi"><small>Dividende annuel total</small><b id="annual">—</b></div>
    </div>

    <div class="pill" id="currentBlock" style="display:none; margin-top:16px;">
      <div class="grid" style="margin-top:10px;">
        <div class="kpi">
          <small class="tip">Rendement actuel
            <span class="info">ⓘ
              <span class="tiptext">Dividende par action ÷ cours actuel × 100.</span>
            </span>
          </small>
          <b id="currentYield">—</b>
        </div>
        <div class="kpi">
          <small class="tip">P/L latent
            <span class="info">ⓘ
              <span class="tiptext">Plus/moins-value non réalisée = valeur de position − coût total.</span>
            </span>
          </small>
          <b id="plAmount">—</b>
        </div>
        <div class="kpi">
          <small class="tip">P/L (%)
            <span class="info">ⓘ
              <span class="tiptext">((Cours actuel − PRU) ÷ PRU) × 100.</span>
            </span>
          </small>
          <b id="plPct">—</b>
        </div>
        <div class="kpi"><small>Valeur de la position</small><b id="mktValue">—</b></div>
      </div>
    </div>

    <!-- ==== CATÉGORIE 3 : Estimations futures sur 10 ans ==== -->
    <h3 class="section-title violet-title" style="margin-top:56px;">Estimations futures sur 10 ans</h3>

    <!-- Lignes à 2 colonnes pleine largeur -->
    <div class="proj-grid-2">
      <div class="kpi">
        <small>Taux de croissance du dividende (% / an)</small>
        <b>
          <input id="divGrowth" type="number" inputmode="decimal" value="3" style="width:100%;margin-top:8px;">
        </b>
      </div>
      <div class="kpi">
        <small>Taux de croissance du prix (% / an)</small>
        <b>
          <input id="priceGrowth" type="number" inputmode="decimal" value="0" style="width:100%;margin-top:8px;">
        </b>
      </div>
    </div>

    <div class="proj-grid-2" style="margin-top:12px;">
      <div class="kpi">
        <small>Investissement supplémentaire :</small>
        <b>
          <input id="extraInvestment" type="number" inputmode="decimal" placeholder="ex: 100" style="width:100%;margin-top:8px;">
        </b>
      </div>
      <div class="kpi">
        <small>Fréquence de l’investissement :</small>
        <b>
          <select id="extraInvestFreq" style="width:100%;margin-top:8px;">
            <option value="monthly" selected>Mensuelle</option>
            <option value="quarterly">Trimestrielle</option>
            <option value="yearly">Annuelle</option>
            <option value="once">Ponctuelle</option>
          </select>
        </b>
      </div>
    </div>

    <!-- Deux boutons côte à côte -->
    <div class="proj-actions">
      <button class="btn" id="calcProj">SANS DRIP</button>
      <button class="btn" id="calcProjDrip">AVEC DRIP</button>
    </div>
    <div class="drip-note tip">
      DRIP = Dividend Reinvestment Plan (Plan de réinvestissement des dividendes)
      <span class="info">ⓘ
        <span class="tiptext">Avec DRIP, les dividendes sont utilisés pour acheter automatiquement des actions supplémentaires au prix projeté, augmentant le nombre d’actions au fil du temps.</span>
      </span>
    </div>

    <!-- Résumé au-dessus du graphique -->
    <div id="summary" class="summary">Après 10 ans, vos dividendes cumulés atteignent — €, soit une croissance totale de — %.</div>
    <div id="diffSummary" class="summary"></div>

    <div class="card chart-card" style="padding:16px; margin-top:16px;">
      <canvas id="projChart" height="140"></canvas>
    </div>

    <table class="tbl" id="resultTable">
      <thead>
        <tr>
          <th style="text-align:left">Année</th>
          <th>Dividendes</th>
          <th>Rendement (%)</th>
          <th>Nombre d’actions</th>
          <th>Valeur du portefeuille</th>
        </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>

    <!-- ADS PLACEHOLDER (milieu de page) -->
    <!--
      [ADS_MID] Rectangle 300x250 / 336x280 / responsive
      Exemple : <div id="ads-mid"></div>
    -->

    <!-- Placeholders liens d’affiliation (neutres, non intrusifs) -->
    <!--
      [AFFILIATES]
      <ul>
        <li><a href="#" rel="nofollow sponsored">Courtier A – Compte dividendes</a></li>
        <li><a href="#" rel="nofollow sponsored">Outil B – Suivi de portefeuille</a></li>
        <li><a href="#" rel="nofollow sponsored">Livre C – Investir en dividendes</a></li>
      </ul>
    -->
  </div>

  <!-- BOUTON EN BAS : Réinitialiser plein largeur -->
  <div class="actions">
    <button class="btn" id="clear">Réinitialiser</button>
  </div>

  <!-- ADS PLACEHOLDER (footer) -->
  <!--
    [ADS_FOOT] Bannière 728x90 / responsive
    Exemple : <div id="ads-foot"></div>
  -->

  <div class="foot">⚠️ Estimations indicatives. Les dividendes et les prix peuvent varier.</div>
</div>

<script>
const $ = id => document.getElementById(id);
const fmtNum = x => isNaN(x)?'—':new Intl.NumberFormat('fr-FR',{maximumFractionDigits:2}).format(x);
const fmtPct = x => (isNaN(x)||!isFinite(x))?'—':x.toFixed(2)+' %';

/* Accepter virgules et points */
const parseNum = (v) => {
  if (v === null || v === undefined) return NaN;
  const s = String(v).trim().replace(',', '.');
  return parseFloat(s);
};

function resolvePRU(pru) {
  if (!isNaN(pru) && pru>0) return pru;
  return NaN;
}
function resolveDPS(mode, val, refPrice){
  if (mode==='amount') return val;
  if (mode==='percent') return (refPrice>0)? (val/100)*refPrice : NaN;
  return NaN;
}

function compute(){
  const s   = parseNum($('shares').value);
  const pruInput = parseNum($('pru').value);
  const cur = parseNum($('currentPrice').value);
  const dMode = $('dMode').value;
  const dVal  = parseNum($('dVal').value);

  const pru = resolvePRU(pruInput);
  const refForPercent = (!isNaN(cur)&&cur>0) ? cur : pru;
  const dps = resolveDPS(dMode, dVal, refForPercent);

  $('yocRef').textContent = isNaN(pru) ? "PRU non défini." : `Calcul basé sur PRU = ${fmtNum(pru)}`;

  let cost = NaN, annual = NaN, yoc = NaN;
  if (s>0 && !isNaN(pru)) cost = s*pru;
  if (s>0 && !isNaN(dps)) annual = s*dps;
  if (!isNaN(pru) && !isNaN(dps)) yoc = (dps/pru)*100;

  $('yieldOnCost').textContent = fmtPct(yoc);
  $('cost').textContent = fmtNum(cost);
  $('annual').textContent = fmtNum(annual);
  $('monthly').textContent = fmtNum(annual/12);
  $('quarterly').textContent = fmtNum(annual/4);

  if (!isNaN(cur) && cur>0){
    const mkt = s*cur;
    const plAmt = (!isNaN(cost)? mkt - cost : NaN);
    const plPct = (!isNaN(pru)? ((cur - pru)/pru)*100 : NaN);
    const curYield = (!isNaN(dps)? (dps/cur)*100 : NaN);

    $('currentBlock').style.display = '';
    $('currentYield').textContent = fmtPct(curYield);
    $('plAmount').textContent = fmtNum(plAmt);
    $('plPct').textContent = fmtPct(plPct);
    $('mktValue').textContent = fmtNum(mkt);
  } else {
    $('currentBlock').style.display = 'none';
  }

  computeProjections(false);
  saveToHash();
}

/* ===== Projections (REMPLACÉE PAR TA VERSION) ===== */
let projChart;
let lastRows = []; // pour Export CSV

function computeProjections(useDRIP=false){
  let shares = parseNum($('shares').value);
  const initShares = isNaN(shares)?0:shares;

  const dMode = $('dMode').value;
  const dVal  = parseNum($('dVal').value);
  const cur = parseNum($('currentPrice').value);
  const pru = resolvePRU(parseNum($('pru').value));
  const refForPercent = (!isNaN(cur)&&cur>0) ? cur : pru;

  const dps0 = resolveDPS(dMode, dVal, refForPercent);
  const initDps = isNaN(dps0)?0:dps0;

  const price0Raw = (!isNaN(cur)&&cur>0)? cur : pru;
  let price = isNaN(price0Raw) ? 0 : price0Raw;

  const gDiv = parseNum($('divGrowth').value||0)/100;   // croissance annuelle du DPS
  const gPrc = parseNum($('priceGrowth').value||0)/100; // croissance annuelle du prix

  // >>> NOUVEAU : lecture des apports
  const extra = Math.max(0, parseNum($('extraInvestment').value)||0);
  const freq  = $('extraInvestFreq').value || 'monthly';
  const steps = (freq==='monthly') ? 12
              : (freq==='quarterly') ? 4
              : (freq==='yearly') ? 1
              : (freq==='once') ? 1
              : 0;
  // croissance par sous-période (si 0, reste 0)
  const rg = (gPrc>0 && steps>0) ? Math.pow(1+gPrc, 1/steps) - 1 : 0;

  const Y = 10;

  const labels = [];
  const divSeries = [];
  const valSeries = [];
  const tbody = $('resultBody');
  tbody.innerHTML = '';
  lastRows = [];

  let dps = initDps;
  let totalDiv = 0;

  for(let y=1; y<=Y; y++){
    // 1) Dividendes de l'année basés sur les actions détenues au début de l'année
    const sharesStart = isNaN(shares)?0:shares;
    const dividends = sharesStart * dps;

    // 2) Apports périodiques de l'année: on achète progressivement au prix projeté
    //    - monthly: 12 apports, quarterly: 4, yearly: 1, once: 1 (seulement année 1)
    let priceInYear = price; // prix au début de l'année
    if (extra>0 && steps>0 && !(freq==='once' && y>1)){
      for (let k=0; k<steps; k++){
        // achat avant l'update du prix de la sous-période
        if (priceInYear>0){
          shares += (extra / priceInYear);
        }
        // progression du prix sur la sous-période
        if (rg!==0) priceInYear *= (1+rg);
      }
      // en fin d'année, le prix doit être celui après steps sous-périodes
      price = priceInYear;
    } else {
      // pas d’apport: prix progresse simplement sur l’année
      price *= (1+gPrc);
    }

    // 3) Valeur en fin d'année (après apports, avant DRIP sur dividendes)
    const valueEnd = (isNaN(shares)?0:shares) * price;
    const yieldPct = (price>0 && dps>0) ? (dps/price)*100 : NaN;

    // 4) DRIP en fin d'année: réinvestit les dividendes au prix de fin d'année
    if (useDRIP && price>0){
      shares += (dividends / price);
    }

    // 5) Agrégats d'affichage & cumul
    labels.push('Année '+y);
    divSeries.push(dividends);
    valSeries.push(valueEnd);
    totalDiv += dividends;

    const row = {
      annee: y,
      dividendes: dividends,
      rendement_pct: yieldPct,
      actions: shares,       // actions détenues immédiatement après la fin d'année (apports + DRIP éventuel)
      valeur: valueEnd       // valeur avant DRIP (pour rester cohérent avec l'affichage existant)
    };
    lastRows.push(row);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left">${y}</td>
      <td>${fmtNum(dividends)}</td>
      <td>${fmtPct(yieldPct)}</td>
      <td>${fmtNum(row.actions)}</td>
      <td>${fmtNum(row.valeur)}</td>
    `;
    tbody.appendChild(tr);

    // 6) croissance du DPS pour l'année suivante
    dps *= (1+gDiv);
  }

  // Résumé synthétique
  const baseline = initShares * initDps * Y;
  const growthPct = (baseline>0) ? ((totalDiv - baseline)/baseline)*100 : NaN;
  $('summary').textContent = `Après 10 ans, vos dividendes cumulés atteignent ${fmtNum(totalDiv)} €, soit une croissance totale de ${fmtPct(growthPct)}.`;

  // Différence DRIP vs sans DRIP (recalcul avec mêmes apports, sans DRIP)
  let sharesNo = initShares;
  let dpsNo = initDps;
  let priceNo = isNaN(price0Raw)?0:price0Raw;
  let totalDivNo = 0;

  for(let y=1; y<=Y; y++){
    const divNo = (isNaN(sharesNo)?0:sharesNo) * dpsNo;
    totalDivNo += divNo;

    // apports
    let pIn = priceNo;
    if (extra>0 && steps>0 && !(freq==='once' && y>1)){
      const rgNo = (gPrc>0 && steps>0) ? Math.pow(1+gPrc, 1/steps) - 1 : 0;
      for (let k=0; k<steps; k++){
        if (pIn>0) sharesNo += (extra / pIn);
        if (rgNo!==0) pIn *= (1+rgNo);
      }
      priceNo = pIn;
    } else {
      priceNo *= (1+gPrc);
    }

    // pas de DRIP ici
    dpsNo *= (1+gDiv);
  }

  const diffEl = $('diffSummary');
  if (useDRIP) {
    const diffAmt = totalDiv - totalDivNo;
    const diffPct = (totalDivNo>0)? (diffAmt/totalDivNo)*100 : NaN;
    diffEl.textContent = `Différence : ${diffAmt>=0?'+':''}${fmtNum(diffAmt)} € (${fmtPct(diffPct)}) grâce au réinvestissement des dividendes.`;
  } else {
    diffEl.textContent = '';
  }

  const ctx = document.getElementById('projChart').getContext('2d');
  if(projChart) projChart.destroy();
  projChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Total dividendes',
          data: divSeries,
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--violet').trim(),
          borderWidth: 0,
          barPercentage: 0.45,
          categoryPercentage: 0.7
        },
        {
          label: 'Valeur du portefeuille',
          data: valSeries,
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--rose').trim(),
          borderWidth: 0,
          barPercentage: 0.45,
          categoryPercentage: 0.7
        }
      ]
    },
    options: {
      responsive:true,
      interaction:{mode:'index', intersect:false},
      scales:{ y:{beginAtZero:true, ticks:{ callback:(v)=> new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(v) }}},
      plugins:{ legend:{ position:'bottom' } }
    }
  });
}

// Thème (bouton en haut, sous Partager) + par défaut "jour"
const root = document.documentElement;
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  root.setAttribute('data-theme', savedTheme);
} else {
  root.setAttribute('data-theme', 'light'); // Forcer l'affichage initial jour
}
$('themeToggle').onclick = ()=>{
  const isDark = root.getAttribute('data-theme')==='dark';
  const next = isDark ? 'light' : 'dark';
  root.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
};

// Partage + Export CSV
function saveToHash(){
  const params = new URLSearchParams({
    shares:$('shares').value, pru:$('pru').value,
    current:$('currentPrice').value, dMode:$('dMode').value, dVal:$('dVal').value,
    gDiv:$('divGrowth').value, gPrc:$('priceGrowth').value
  });
  history.replaceState(null,'','#'+params.toString());
}
function loadFromHash(){
  if(location.hash.length>1){
    const p = new URLSearchParams(location.hash.slice(1));
    if(p.get('shares')) $('shares').value = p.get('shares');
    if(p.get('pru')) $('pru').value = p.get('pru');
    if(p.get('current')) $('currentPrice').value = p.get('current');
    if(p.get('dMode')) $('dMode').value = p.get('dMode');
    if(p.get('dVal')) $('dVal').value = p.get('dVal');
    if(p.get('gDiv')) $('divGrowth').value = p.get('gDiv');
    if(p.get('gPrc')) $('priceGrowth').value = p.get('gPrc');
  }
}

/* Logique du menu Partager */
const shareBtn = $('shareBtn');
const shareMenu = $('shareMenu');
shareBtn.addEventListener('click', ()=>{
  saveToHash();
  shareMenu.style.display = (shareMenu.style.display==='block'?'none':'block');
});
document.addEventListener('click', (e)=>{
  if(!shareMenu.contains(e.target) && e.target!==shareBtn){
    shareMenu.style.display = 'none';
  }
});
$('copyLink').addEventListener('click', ()=>{
  saveToHash();
  navigator.clipboard.writeText(location.href).then(()=>{
    $('copyLink').textContent='Lien copié ✅';
    setTimeout(()=>{$('copyLink').textContent='Copier le lien'},1200);
  });
});
$('shareEmail').addEventListener('click', (e)=>{
  e.preventDefault(); saveToHash();
  const subject = encodeURIComponent('Mon calcul de dividendes');
  const body = encodeURIComponent(`Voici mon lien:\n${location.href}`);
  location.href = `mailto:?subject=${subject}&body=${body}`;
});
$('shareFB').addEventListener('click', (e)=>{
  e.preventDefault(); saveToHash();
  const u = encodeURIComponent(location.href);
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${u}`,'_blank','noopener');
});
$('shareIG').addEventListener('click', ()=>{
  saveToHash();
  navigator.clipboard.writeText(location.href).then(()=>{
    alert("Lien copié. Ouvre Instagram et colle-le dans ta bio ou un message.");
  });
});
$('shareX').addEventListener('click', (e)=>{
  e.preventDefault(); saveToHash();
  const text = encodeURIComponent('Mon calcul de dividendes');
  const url = encodeURIComponent(location.href);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`,'_blank','noopener');
});
/* Export CSV du tableau */
$('exportCSV').addEventListener('click', ()=>{
  // par défaut exporte la dernière projection affichée
  const rows = lastRows;
  const header = ['Année','Dividendes','Rendement (%)','Nombre d’actions','Valeur du portefeuille'];
  const csv = [
    header.join(';'),
    ...rows.map(r => [r.annee, r.dividendes, r.rendement_pct, r.actions, r.valeur].join(';'))
  ].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dividendes_projections.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* Bouton Réinitialiser */
$('clear').onclick = ()=>{
  ['shares','pru','currentPrice','dVal','divGrowth','priceGrowth','extraInvestment'].forEach(id => $(id).value='');
  $('extraInvestFreq').value='monthly';
  $('dMode').value='amount';
  compute();
};

// Events
$('calc').addEventListener('click', compute);
$('calcProj').addEventListener('click', ()=>computeProjections(false));  // SANS DRIP
$('calcProjDrip').addEventListener('click', ()=>computeProjections(true)); // AVEC DRIP
['shares','pru','currentPrice','dVal','dMode','divGrowth','priceGrowth','extraInvestment','extraInvestFreq']
  .forEach(id => $(id).addEventListener('change', ()=>{}));

loadFromHash();
compute();
</script>
</body>
</html>

